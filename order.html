<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>주문하기</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #999; background: #fafafa; cursor: pointer; }
    input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    ul { padding-left: 18px; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <h1>주문하기</h1>
  <div id="uid" class="muted">사용자 확인 중…</div>

  <div class="card">
    <h3>장바구니</h3>
    <div class="row">
      <input id="itemName" type="text" placeholder="상품명 (예: 사과)" />
      <input id="itemQty" type="number" min="1" value="1" />
      <button id="addItem">추가</button>
    </div>
    <ul id="cartList"></ul>
  </div>

  <div class="card">
    <div class="row">
      <button id="placeOrder">서버에 주문 저장</button>
      <a href="/launch/view-order" id="viewLink">내 QR코드 확인</a>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const cart = [];
    function renderCart(){
      const ul = $("#cartList");
      ul.innerHTML = "";
      cart.forEach(it => {
        const li = document.createElement("li");
        li.textContent = `${it.name} x ${it.qty}`;
        ul.appendChild(li);
      });
    }
    $("#addItem").addEventListener("click", () => {
      const n = $("#itemName").value.trim();
      const q = parseInt($("#itemQty").value || "1", 10);
      if (!n) return alert("상품명을 입력하세요");
      if (q <= 0) return alert("수량은 1 이상");
      cart.push({ name: n, qty: q });
      $("#itemName").value = ""; $("#itemQty").value = "1";
      renderCart();
    });

    async function whoami(){
      const res = await fetch("/api/whoami");
      const js = await res.json();
      return js.user_id || null;
    }

    async function ensureLogin(redirectBackTo="/launch/order"){
      const uid = await whoami();
      if (uid) return uid;
      // store where to return after login
      document.cookie = "post_login_redirect=" + encodeURIComponent(redirectBackTo) + ";path=/";
      // jump to Kakao consent
      location.href = "/oauth/kakao/start";
      return null;
    }

    async function sendOrderToServer(orderData) {
      const res = await fetch("/api/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData),
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error("create-order failed: " + t);
      }
      return await res.json();
    }

    (async () => {
      const uidLabel = $("#uid");
      let uid = await whoami();
      if (!uid) {
        uidLabel.innerHTML = '로그인이 필요합니다. <a href="/oauth/kakao/start">카카오로 계속하기</a>';
      } else {
        uidLabel.textContent = "사용자 ID: " + uid;
      }

      $("#placeOrder").addEventListener("click", async () => {
        let userId = await whoami();
        if (!userId) {
          userId = await ensureLogin("/launch/order");
          return; // redirecting
        }
        if (cart.length === 0) return alert("장바구니를 채워주세요.");
        const payload = { userId, items: cart.slice(), orderTimestamp: new Date().toISOString() };
        $("#status").textContent = "주문 저장 중...";
        try {
          const res = await sendOrderToServer(payload);
          if (!res.success) throw new Error("server rejected");
          $("#status").textContent = "저장 완료! '내 QR코드 확인'으로 이동하세요.";
        } catch (e) {
          console.error(e);
          $("#status").textContent = "실패: " + e.message;
          alert("주문 저장 중 오류가 발생했습니다.");
        }
      });
    })();
  </script>
</body>
</html>
