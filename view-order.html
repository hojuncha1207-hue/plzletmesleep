<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>내 QR코드 확인</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .muted { color: #666; }
    #qr { margin-top: 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/kjua@0.9.0/dist/kjua.min.js"></script>
</head>
<body>
  <h1>내 QR코드 확인</h1>
  <div id="out" class="card">불러오는 중…</div>
  <div id="qr"></div>
  <p class="muted">* 주문이 없으면 NOT_FOUND가 표시됩니다. 서버 재시작 시 인메모리 데이터는 초기화됩니다.</p>

  <script>
    async function whoami(){
      const res = await fetch("/api/whoami");
      const js = await res.json();
      return js.user_id || null;
    }
    (async () => {
      const out = document.getElementById("out");
      const qrWrap = document.getElementById("qr");
      let uid = await whoami();
      if (!uid) {
        // ask login, then bounce back here
        document.cookie = "post_login_redirect=" + encodeURIComponent("/launch/view-order") + ";path=/";
        location.href = "/oauth/kakao/start";
        return;
      }
      try {
        const res = await fetch(`/api/order`); // server resolves user via cookie
        if (!res.ok) { out.textContent = "주문 정보를 찾을 수 없습니다."; return; }
        const data = await res.json();
        if (!data.success) { out.textContent = "주문 정보를 찾을 수 없습니다."; return; }
        const order = data.data;
        out.innerHTML = `
          <div><b>주문번호</b>: ${order.orderId}</div>
          <div><b>사용자</b>: ${order.userId}</div>
          <div><b>시간</b>: ${order.orderTimestamp}</div>
          <div><b>상품 수</b>: ${order.items.length}</div>
        `;
        const qrText = order.qr.startsWith("http") ? order.qr : (location.origin + order.qr);
        const node = kjua({ text: qrText, render: "image", crisp: true, size: 256, quiet: 2, ecLevel: "M" });
        qrWrap.innerHTML = "";
        qrWrap.appendChild(node);
      } catch (e) {
        console.error(e);
        out.textContent = "오류가 발생했습니다.";
      }
    })();
  </script>
</body>
</html>
