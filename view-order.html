<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>내 QR코드 확인</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .muted { color: #666; }
    #qr { margin-top: 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/kjua@0.9.0/dist/kjua.min.js"></script>
  <script>
    function getCookie(name) {
      const ca = document.cookie.split(';');
      for (let c of ca) {
        c = c.trim();
        if (c.indexOf(name + "=") === 0) return decodeURIComponent(c.substring(name.length + 1));
      }
      return "";
    }
  </script>
</head>
<body>
  <h1>내 QR코드 확인</h1>
  <div id="out" class="card">불러오는 중…</div>
  <div id="qr"></div>
  <p class="muted">* "주문 정보를 찾을 수 없습니다."가 뜨면 user_id가 다르거나 주문이 저장되지 않았거나 서버 재시작으로 데이터가 초기화되었을 수 있습니다.</p>

  <script>
    (async () => {
      const p = new URLSearchParams(location.search);
      let userId = p.get("user_id") || getCookie("k_uid");
      const out = document.getElementById("out");
      const qrWrap = document.getElementById("qr");

      if (!userId) {
        out.textContent = "user_id 파라미터가 없습니다.";
        return;
      }

      try {
        const res = await fetch(`/api/order?user_id=${encodeURIComponent(userId)}`);
        if (!res.ok) { out.textContent = "주문 정보를 찾을 수 없습니다."; return; }
        const data = await res.json();
        if (!data.success) { out.textContent = "주문 정보를 찾을 수 없습니다."; return; }

        const order = data.data;
        out.innerHTML = `
          <div><b>주문번호</b>: ${order.orderId}</div>
          <div><b>사용자</b>: ${order.userId}</div>
          <div><b>시간</b>: ${order.orderTimestamp}</div>
          <div><b>상품 수</b>: ${order.items.length}</div>
        `;

        // 서버가 저장한 qr 내용을 우선 사용
        const qrText = order.qr ? (order.qr.startsWith("http") ? order.qr : (location.origin + order.qr)) :
                                   `${location.origin}/launch/view-order?user_id=${encodeURIComponent(order.userId)}`;

        const node = kjua({ text: qrText, render: "image", crisp: true, size: 256, quiet: 2, ecLevel: "M" });
        qrWrap.innerHTML = "";
        qrWrap.appendChild(node);
      } catch (e) {
        console.error(e);
        out.textContent = "오류가 발생했습니다.";
      }
    })();
  </script>
</body>
</html>
